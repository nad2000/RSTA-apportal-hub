{% extends 'detail.html' %}

{% load i18n crispy_forms_tags tags %}
{% block sidebar %}{% include 'sidebar.html' with category="applications" %}{% endblock sidebar %}

{% if form %}
  {% block css %}
    {{ form.media.css }}
    {{ block.super }}
  {% endblock %}
{% endif %}

{% block content %}

  {% if form %}{% crispy form %}{% endif %}

  {% with a=object u=request.user %}
  <div class="table-responsive">
  <table class="table table-bordered searchable">
    <tbody>

          <tr>
            <th class="table-dark" scope="row" style="width: 21%; min-width: 160px; max-width: 180px;">
              {% trans 'Application' %}</th>
            <td colspan="3">
              {% if u.is_superuser %}
                <a href="{% url 'admin:portal_application_change' object_id=a.id %}">
                  {{ a.number }}{% if a.application_title %}: {{ a.application_title }}{% endif %}
                </a>
              {% else %}
                {{ a.number }}{% if a.application_title %}: {{ a.application_title }}{% endif %}
              {% endif %}
            </td>
          </tr>

          {% if a.presentation_url %}
          <tr>
            <td colspan="4">

              {% if "youtube" in a.presentation_url or "vimeo" in a.presentation_url %}

                <iframe
                src="{% if "vimeo" in a.presentation_url %}https://player.vimeo.com/video/{% else %}https://www.youtube.com/embed/{% endif %}{{ a.presentation_url|video_id }}"
                  title="{% trans 'Vimeo video player' %}"
                  width="640"
                  height="360"
                  frameborder="0"
                  allow="fullscreen; accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                ></iframe>

              {% else %}
                <video
                  width="640"
                  height="360"
                  controls
                >
                  <source src="{{ a.presentation_url }}">
                  {% trans 'Your browser does not support the video tag.' %}
                </video>

              {% endif %}

              <p><a href="{{ a.presentation_url }}">{{ a.application_title|default:a.presentation_url }}</a>.</p>

            </td>
          </tr>
          {% endif %}

          {% if a.submitted_by %}
            <tr>
              <th class="table-dark" class="thead-dark" scope="row">{% trans 'Submitted By' %}</th>
              <td colspan="3">{{ a.submitted_by }}</td>
            </tr>
          {% endif %}

          <tr>
            <th class="table-dark" scope="row">{% trans 'Round' %}</th>
            <td colspan="3">{{ a.round }}</td>
          </tr>

          {% if a.is_team_application or a.members.all.count %}

            <tr>
              <th class="table-dark" scope="row">{% trans 'Team:' %}</th>
              <td colspan="3">
                {%if a.team_name %}{{ a.team_name|default:'' }}:{% endif %}
                <ul>
                  {% for m in a.members.all %}
                    <li>
                      {% if u.is_staff or u.is_superuser %}
                        <a href="{% url 'admin:portal_member_change' object_id=m.id %}"> {{ m | person_with_email }} </a>
                      {% else %}
                        {{ m | person_with_email }}
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </td>
            </tr>

          {% endif %}

          <tr>
            <th class="table-dark" scope="row">{% trans 'Applicant' %}</th>
            <td colspan="3">{{ a|person_with_email }}</td>
          </tr>

          <tr>
            <th class="table-dark" scope="row" style="width: 21%; min-width: 120px; max-width: 180px;">{% trans 'Organisation' %}</th>
            <td>{% if a.org %}{{ a.org }}{% else %}{{ a.organisation|default:'' }}{% endif %}</td>
            <th class="table-dark" scope="row" style="width: 21%; min-width: 120px; max-width: 180px;">{% trans 'Position' %}</th>
            <td>{{ a.position|default:'' }}</td>
          </tr>

          <tr>
            <th class="table-dark" scope="row">{% trans 'Postal Address' %}</th>
            <td colspan="3">
              {{ a.postal_address }}{% if a.city %},<br/>{{a.city}}{% endif %}{% if a.state %},<br/>{{a.state}}{% endif %}{% if a.postcode %}, {{a.postcode}} {% endif %}
            </td>
          </tr>

          <tr>
            <th class="table-dark" scope="row">{% trans 'Daytime Phone Number' %}</th>
            <td>{{ a.daytime_phone_number }}</td>
            <th class="table-dark" scope="row">{% trans 'Mobile Phone Number' %}</th>
            <td>{{ a.mobile_phone_number }}</td>
          </tr>

          {% if not show_basic_details %}

            {% if a.summary or a.summary_en or a.summary_mi %}
              {% if a.is_bilingual_summary %}

                {% if a.summary_en %}
                  <tr>
                    <th class="table-dark" scope="row">{% trans 'Summary (English)' %}</th>
                    <td colspan="3">
                      {{ a.summary_en|safe }}
                    </td>
                  </tr>
                {% endif %}

                {% if a.summary_mi %}
                  <tr>
                    <th class="table-dark" scope="row">{% trans 'Summary (Maori)' %}</th>
                    <td colspan="3">
                      {{ a.summary_mi|safe }}
                    </td>
                  </tr>
                {% endif %}

              {% elif a.summary %}
                <tr>
                  <th class="table-dark" scope="row">{% trans 'Summary' %}</th>
                  <td colspan="3">{{ a.summary|safe }}</td>
                </tr>
              {% endif %}
          {% endif %}

          <tr>
            <th class="table-dark" scope="row">{% trans 'Completed Application Form' %}</th>
            <td colspan="3">
              {% if a.file %}
                {% if a|can_edit:user %}
                  <a href="{{ a.file.url }}" target="_blank"> {{ a.filename }} </a>
                {% else %}
                  <a href="{{ a.pdf_file.url }}" target="_blank"> {{ a.pdf_filename }} </a>
                {% endif %}
              {% else %}
                {% trans 'N/A' %}
              {% endif %}
            </td>
          </tr>

          {% if a.converted_file and a|can_edit:user %}
            <tr>
              <th class="table-dark" scope="row">{% trans 'Completed Application Form (PDF version)' %}</th>
              <td colspan="3">
                    <a href="{{ a.converted_file.file.url }}" target="_blank"> {{ a.converted_file.file.name|basename }} </a>
              </td>
            </tr>
          {% endif %}

        {% endif %}

        {% if u.is_staff or u.is_superuser %}
          <tr>
            <th class="table-dark" scope="row">{% trans 'Photo Identity' %}</th>
            <td colspan="3">
              {% if a.photo_identity %}<a href="{{ a.photo_identity.url }}" target="_blank">
                  {{ a.photo_identity.name|basename }}
            </a>{% else %}{% trans 'N/A' %}{% endif %}
            </td>
          </tr>
        {% endif %}

        {% if a.referees.all.count and a|can_see_referees:u %}
          <tr>
            <th class="table-dark" scope="row">{% trans 'Referees' %}</th>
            <td colspan="3">
              <ul>
              {% for r in a.referees.all %}
                <li>
                  {% if u.is_staff or u.is_superuser %}
                    <a href="{% url 'admin:portal_referee_change' object_id=r.id %}">
                      {{ r | person_with_email }}
                    </a>
                  {% else %}
                    {{ r | person_with_email }}
                  {% endif %}
                </li>
              {% endfor %}
              </ul>
            </td>
          </tr>
        {% endif %}

    </tbody>
  </table>
  </div>

  <div class="buttonHolder mb-5 mt-3 float-right">

    <div class="tooltip-wrapper{% if scheme.application.state == 'submitted'%} disabled{% endif %}"
        {% if was_submitted %}
          disabled
          data-title="{% trans 'The application has been already submitted and cannot be modified' %}"
        {% elif not is_owner %}
          disabled
          data-title="{% trans 'Only the main applicant or a team member can edit the application' %}"
        {% else %}
          data-title="{% trans 'Modify your application and continue application process' %}"
        {% endif %}
    >
      <a href="{% url update_view_name pk=a.pk %}"
          class="btn btn-primary{% if not is_owner or was_submitted %} disabled{% endif %}"
      >{% trans update_button_name %}
      </a>
    </div>

    {% if export_button_view_name %}
      <div class="tooltip-wrapper{% if show_basic_details %} disabled{% endif %}"
          {% if show_basic_details %}
            disabled
            data-title="{% trans 'Only the applicants and the panellists that submitted a statement of conflict of interest can export the application' %}"
          {% else %}
            data-title="{% trans 'Export the application into a consolidated PDF file' %}"
          {% endif %}
      >
      <a class="btn btn-primary{% if show_basic_details %} disabled{% endif %}" href="{% url export_button_view_name pk=a.pk %}">{% trans 'Export' %}</a>
      </div>
    {% endif %}

    {% if testimonial %}

      <div class="tooltip-wrapper{% if testimonial.state == "submitted" %} disabled{% endif %}"
          {% if testimonial.state == "submitted" %}
            disabled
            data-title="{% trans 'The testimonial was already submitted and cannot be updated' %}"
          {% else %}
            data-title="{% trans 'Update and submit the testimonial' %}"
          {% endif %}
      >
      <a class="btn btn-outline-primary{% if testimonial.state == "submitted" %} disabled{% endif %}"
      href="{% url 'testimonial-update' pk=testimonial.pk %}">{% trans 'Update' %} <strong>{% trans 'Testimonial' %}</strong></a>
      </div>
    {% endif %}

  </div>

{% endwith %}
{% endblock %}

{% block javascript %}
  {{ block.super }}
  {% if form %}
    {{ form.media.js }}
  {% endif %}
  <script>
    $(document).ready(function(){
        $('.tooltip-wrapper').tooltip(); // .tooltip({position: "bottom"});
    });
  </script>
{% endblock javascript %}
